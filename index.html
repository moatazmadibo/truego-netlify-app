<!doctype html><html lang="ar"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>TrueGo – Test Payment (Testnet)</title>
<h1>TrueGo Testnet – Process a Transaction</h1>
<button id="pay">ادفع تجربة 0.01 π</button>
<pre id="log"></pre>
<script>
  const log=(...a)=>document.querySelector('#log').textContent+=a.join(' ')+"\n";
  if(window.Pi){try{window.Pi.init({version:"2.0",sandbox:true});}catch(e){log(e)}}
  else{log("افتح الصفحة من داخل Pi Browser.");}
  async function post(u,d){const r=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});const t=await r.text();try{return JSON.parse(t)}catch{return{raw:t}}}
  document.querySelector('#pay').onclick=async()=>{
    try{
      const me=await window.Pi.authenticate(["username"],{onIncompletePaymentFound:()=>{}});
      log("User:",me?.user?.username||"unknown");
      const data={amount:0.01,memo:"TrueGo test payment",metadata:{checklist:true}};
      const cbs={
        onReadyForServerApproval: async id=>{log("approve→",id);log(await post("/.netlify/functions/approve",{paymentId:id}));},
        onReadyForServerCompletion: async (id,txid)=>{log("complete→",id,txid);log(await post("/.netlify/functions/complete",{paymentId:id,txid}));},
        onCancel:id=>log("cancel:",id),
        onError:(err,id)=>log("error:",id,err?.message||err)
      };
      const p=await window.Pi.createPayment(data,cbs);
      const res=await p.complete();
      log("finished:",JSON.stringify(res)); alert("✅ تمت عملية الدفع التجريبية");
    }catch(e){log("Exception:",e.message||e); alert("حدث خطأ أثناء الدفع");}
  };
</script>
</html>
